# Fix: Call to undefined method update_coach()

## üêõ Erreur

```
Fatal error: Uncaught Error: Call to undefined method JuniorGolfKenya_Database::update_coach() 
in C:\xampp\htdocs\wordpress\wp-content\plugins\juniorgolfkenya\admin\partials\juniorgolfkenya-admin-coaches.php:108
```

## üîç Analyse

### Cause

**Fichier** : `admin/partials/juniorgolfkenya-admin-coaches.php` (ligne 108)

Le code appelait une m√©thode qui **n'existe pas** dans la classe `JuniorGolfKenya_Database` :

```php
// ‚ùå ERREUR : Cette m√©thode n'existe pas
$result = JuniorGolfKenya_Database::update_coach($coach_id, array(
    'specialties' => implode(',', $specialties),
    'experience_years' => $experience,
    'bio' => $bio
));
```

### Contexte

Dans le m√™me fichier, lors de la **cr√©ation** d'un coach (action `create_coach`), le code utilise **directement** `$wpdb->update()` pour mettre √† jour la table `wp_jgf_coach_profiles` :

```php
// ‚úÖ Code existant pour CREATE (lignes 78-86)
global $wpdb;
$coach_table = $wpdb->prefix . 'jgf_coach_profiles';
$wpdb->update(
    $coach_table,
    array(
        'specialties' => implode(',', $specialties),
        'bio' => $bio,
        'verification_status' => 'approved'
    ),
    array('user_id' => $user_id)
);
```

**Constat** : Le code d'UPDATE devrait utiliser la **m√™me approche** que le code de CREATE.

### Structure des donn√©es coaches

Les donn√©es d'un coach sont stock√©es √† **deux endroits** :

1. **Table `wp_jgf_coach_profiles`** :
   - `specialties` (VARCHAR)
   - `bio` (TEXT)
   - `verification_status` (VARCHAR)
   - `user_id` (INT) - Cl√© √©trang√®re vers wp_users

2. **Table `wp_usermeta`** :
   - `phone` (meta_key + meta_value)
   - `experience_years` (meta_key + meta_value)

**Raison** : Les colonnes `phone` et `experience_years` n'existent **pas** dans la table `wp_jgf_coach_profiles`, donc elles sont stock√©es dans `wp_usermeta`.

## ‚úÖ Solution appliqu√©e

### Modification dans `juniorgolfkenya-admin-coaches.php`

**Avant** (lignes 100-118) :
```php
case 'update_coach':
    $coach_id = intval($_POST['coach_id']);
    $specialties = isset($_POST['specialties']) && is_array($_POST['specialties']) 
        ? array_map('sanitize_text_field', $_POST['specialties']) 
        : array();
    $experience = isset($_POST['experience']) ? intval($_POST['experience']) : 0;
    $bio = isset($_POST['bio']) ? sanitize_textarea_field($_POST['bio']) : '';
    
    // ‚ùå Appelle une m√©thode qui n'existe pas
    $result = JuniorGolfKenya_Database::update_coach($coach_id, array(
        'specialties' => implode(',', $specialties),
        'experience_years' => $experience,  // ‚ùå Cette colonne n'existe pas dans la table
        'bio' => $bio
    ));
    
    if ($result) {
        $message = 'Coach information updated successfully!';
        $message_type = 'success';
    } else {
        $message = 'Failed to update coach information.';
        $message_type = 'error';
    }
    break;
```

**Apr√®s** :
```php
case 'update_coach':
    $coach_id = intval($_POST['coach_id']);
    $specialties = isset($_POST['specialties']) && is_array($_POST['specialties']) 
        ? array_map('sanitize_text_field', $_POST['specialties']) 
        : array();
    $experience = isset($_POST['experience']) ? intval($_POST['experience']) : 0;
    $bio = isset($_POST['bio']) ? sanitize_textarea_field($_POST['bio']) : '';
    
    // ‚úÖ Update user meta for experience (stored separately)
    update_user_meta($coach_id, 'experience_years', $experience);
    
    // ‚úÖ Update coach profile table
    global $wpdb;
    $coach_table = $wpdb->prefix . 'jgf_coach_profiles';
    $result = $wpdb->update(
        $coach_table,
        array(
            'specialties' => implode(',', $specialties),
            'bio' => $bio
        ),
        array('user_id' => $coach_id)
    );
    
    if ($result !== false) {
        $message = 'Coach information updated successfully!';
        $message_type = 'success';
    } else {
        $message = 'Failed to update coach information.';
        $message_type = 'error';
    }
    break;
```

### Am√©liorations

1. ‚úÖ **Suppression de l'appel √† m√©thode inexistante** : Plus d'appel √† `JuniorGolfKenya_Database::update_coach()`

2. ‚úÖ **Mise √† jour de user_meta** : `experience_years` stock√© dans `wp_usermeta` avec `update_user_meta()`

3. ‚úÖ **Mise √† jour de la table coach_profiles** : Utilisation directe de `$wpdb->update()` pour `specialties` et `bio`

4. ‚úÖ **Coh√©rence avec CREATE** : M√™me approche que lors de la cr√©ation d'un coach

5. ‚úÖ **Validation du r√©sultat** : `$result !== false` au lieu de `$result` (car `$wpdb->update()` retourne 0 si aucune ligne modifi√©e)

## üìä Comparaison CREATE vs UPDATE

### Action CREATE (lignes 38-92)

```php
// 1. Cr√©er l'utilisateur WordPress
$user_id = wp_create_user($email, wp_generate_password(), $email);

// 2. Mettre √† jour les d√©tails utilisateur
wp_update_user(array(
    'ID' => $user_id,
    'first_name' => $first_name,
    'last_name' => $last_name,
    'display_name' => $first_name . ' ' . $last_name,
    'role' => 'jgf_coach'
));

// 3. Cr√©er le profil coach
JuniorGolfKenya_User_Manager::create_coach_profile($user_id);

// 4. Stocker phone et experience dans user_meta
update_user_meta($user_id, 'phone', $phone);
update_user_meta($user_id, 'experience_years', $experience);

// 5. Mettre √† jour le profil coach (specialties, bio, verification_status)
global $wpdb;
$coach_table = $wpdb->prefix . 'jgf_coach_profiles';
$wpdb->update(
    $coach_table,
    array(
        'specialties' => implode(',', $specialties),
        'bio' => $bio,
        'verification_status' => 'approved'
    ),
    array('user_id' => $user_id)
);
```

### Action UPDATE (lignes 100-127) - CORRIG√âE

```php
// 1. Mettre √† jour experience dans user_meta
update_user_meta($coach_id, 'experience_years', $experience);

// 2. Mettre √† jour le profil coach (specialties, bio)
global $wpdb;
$coach_table = $wpdb->prefix . 'jgf_coach_profiles';
$result = $wpdb->update(
    $coach_table,
    array(
        'specialties' => implode(',', $specialties),
        'bio' => $bio
    ),
    array('user_id' => $coach_id)
);

// 3. V√©rifier le r√©sultat
if ($result !== false) {
    $message = 'Coach information updated successfully!';
    $message_type = 'success';
} else {
    $message = 'Failed to update coach information.';
    $message_type = 'error';
}
```

**Coh√©rence** : Les deux actions utilisent maintenant la m√™me approche pour mettre √† jour les donn√©es.

## üîç Validation du r√©sultat

### Retour de `$wpdb->update()`

La m√©thode `$wpdb->update()` retourne :
- **`int`** : Nombre de lignes mises √† jour (peut √™tre `0` si aucune modification)
- **`false`** : En cas d'erreur SQL

**Validation correcte** :
```php
if ($result !== false) {  // ‚úÖ Correct : accepte 0 comme succ√®s
    // Success
}
```

**Validation incorrecte** :
```php
if ($result) {  // ‚ùå Incorrect : 0 est √©valu√© comme false
    // Ne sera jamais ex√©cut√© si 0 ligne modifi√©e
}
```

## üß™ Tests √† effectuer

### Test 1 : Mise √† jour compl√®te d'un coach

**Actions** :
1. Aller sur **JGK Coaches Management**
2. Cliquer sur **"Edit"** pour un coach existant
3. Modifier les champs suivants :
   - Specialties (s√©lectionner plusieurs)
   - Experience Years (changer la valeur)
   - Bio (ajouter/modifier du texte)
4. Cliquer sur **"Update Coach"**

**R√©sultats attendus** :
- ‚úÖ Message de succ√®s : "Coach information updated successfully!"
- ‚úÖ Aucune erreur "Call to undefined method"
- ‚úÖ Modifications sauvegard√©es dans la base de donn√©es
- ‚úÖ Modifications visibles lors de la r√©√©dition

**R√©sultats si pas corrig√©** :
- ‚ùå Fatal error : "Call to undefined method JuniorGolfKenya_Database::update_coach()"
- ‚ùå Page blanche (√©cran blanc de la mort)
- ‚ùå Modifications non sauvegard√©es

### Test 2 : Mise √† jour partielle (champs vides)

**Actions** :
1. √âditer un coach
2. Laisser certains champs vides :
   - Specialties : aucune s√©lection
   - Bio : vide
3. Cliquer sur "Update Coach"

**R√©sultats attendus** :
- ‚úÖ Message de succ√®s
- ‚úÖ Champs vides sauvegard√©s correctement
- ‚úÖ Pas d'erreur SQL

### Test 3 : V√©rification en base de donn√©es

**Requ√™te SQL pour v√©rifier user_meta (experience)** :
```sql
SELECT 
    u.ID,
    u.display_name,
    um.meta_value as experience_years
FROM wp_users u
INNER JOIN wp_usermeta um ON u.ID = um.user_id
WHERE um.meta_key = 'experience_years'
AND u.ID IN (
    SELECT user_id FROM wp_usermeta 
    WHERE meta_key = 'wp_capabilities' 
    AND meta_value LIKE '%jgf_coach%'
);
```

**R√©sultat attendu** :
- ‚úÖ Colonne `experience_years` contient la valeur mise √† jour

**Requ√™te SQL pour v√©rifier coach_profiles (specialties, bio)** :
```sql
SELECT 
    cp.user_id,
    u.display_name,
    cp.specialties,
    cp.bio,
    cp.verification_status
FROM wp_jgf_coach_profiles cp
INNER JOIN wp_users u ON cp.user_id = u.ID
ORDER BY cp.user_id DESC
LIMIT 10;
```

**R√©sultat attendu** :
- ‚úÖ Colonnes `specialties` et `bio` contiennent les valeurs mises √† jour

### Test 4 : √âdition puis cr√©ation

**Actions** :
1. √âditer un coach existant (tester UPDATE)
2. Cr√©er un nouveau coach (tester CREATE)

**R√©sultats attendus** :
- ‚úÖ Les deux actions fonctionnent sans erreur
- ‚úÖ Coh√©rence entre CREATE et UPDATE

## üìù Structure finale des donn√©es coach

### Table `wp_jgf_coach_profiles`

| Colonne | Type | Valeur |
|---------|------|--------|
| `id` | INT | Auto-increment |
| `user_id` | INT | WordPress User ID |
| `specialties` | VARCHAR | "junior_coaching,swing_technique" |
| `bio` | TEXT | Biography text |
| `verification_status` | VARCHAR | "approved" |
| `created_at` | DATETIME | Timestamp |
| `updated_at` | DATETIME | Timestamp |

### Table `wp_usermeta` (pour coach)

| meta_key | meta_value |
|----------|------------|
| `phone` | "+254712345678" |
| `experience_years` | "10" |
| `wp_capabilities` | "a:1:{s:9:\"jgf_coach\";b:1;}" |

## üîê S√©curit√© et validation

### Sanitization (d√©j√† en place)

```php
$coach_id = intval($_POST['coach_id']);  // ‚úÖ Entier
$specialties = isset($_POST['specialties']) && is_array($_POST['specialties']) 
    ? array_map('sanitize_text_field', $_POST['specialties'])  // ‚úÖ Tableau d'entiers
    : array();
$experience = isset($_POST['experience']) ? intval($_POST['experience']) : 0;  // ‚úÖ Entier
$bio = isset($_POST['bio']) ? sanitize_textarea_field($_POST['bio']) : '';  // ‚úÖ Texte
```

### Nonce verification (d√©j√† en place)

```php
if (!wp_verify_nonce($_POST['_wpnonce'], 'jgk_coach_action')) {
    wp_die(__('Security check failed.'));
}
```

### Prepared statements

`$wpdb->update()` utilise automatiquement des **prepared statements** pour pr√©venir les injections SQL.

## ‚úÖ Conclusion

### Probl√®me r√©solu

‚úÖ **M√©thode inexistante supprim√©e** : Plus d'appel √† `JuniorGolfKenya_Database::update_coach()`

‚úÖ **Utilisation directe de $wpdb** : Coh√©rent avec le code CREATE

‚úÖ **Mise √† jour user_meta** : `experience_years` stock√© correctement

‚úÖ **Validation correcte** : `!== false` au lieu de simple `if ($result)`

### Impact

- ‚úÖ √âdition de coach ‚Üí **Fonctionne**
- ‚úÖ Aucune erreur fatale ‚Üí **Stable**
- ‚úÖ Donn√©es sauvegard√©es ‚Üí **Persistantes**
- ‚úÖ Coh√©rence CREATE/UPDATE ‚Üí **Maintenue**

### Fichiers modifi√©s

```
admin/partials/juniorgolfkenya-admin-coaches.php
  - Lignes 100-127 : Action update_coach r√©√©crite
  - Suppression : appel √† m√©thode inexistante
  - Ajout : update_user_meta pour experience
  - Ajout : $wpdb->update direct pour coach_profiles
```

### Prochaines √©tapes

1. **Tester l'√©dition de coach** depuis l'interface admin
2. **V√©rifier les logs** pour absence d'erreurs
3. **Confirmer en BDD** que les donn√©es sont mises √† jour
4. **Tester plusieurs coaches** pour s'assurer de la stabilit√©

La fonctionnalit√© d'**√©dition de coach est maintenant op√©rationnelle** ! üéâ
